const countPanel=document.getElementById("countPanel"),infoPanel=document.getElementById("infoPanel"),scorePanel=document.getElementById("scorePanel"),audioContext=new AudioContext,audioBufferCache={};loadAudio("end","mp3/end.mp3"),loadAudio("correct","mp3/correct3.mp3");let japaneseVoices=[];loadVoices();let correctCount=0;loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function loadVoices(){const a=new Promise(function(b){let a=speechSynthesis.getVoices();if(a.length!==0)b(a);else{let c=!1;speechSynthesis.addEventListener("voiceschanged",()=>{c=!0,a=speechSynthesis.getVoices(),b(a)}),setTimeout(()=>{c||document.getElementById("noTTS").classList.remove("d-none")},1e3)}});a.then(a=>{japaneseVoices=a.filter(a=>a.lang=="ja-JP")})}function speak(b){speechSynthesis.cancel();const a=new SpeechSynthesisUtterance(b);a.voice=japaneseVoices[Math.floor(Math.random()*japaneseVoices.length)],a.lang="ja-JP",speechSynthesis.speak(a)}async function playAudio(b,c){const d=await loadAudio(b,audioBufferCache[b]),a=audioContext.createBufferSource();if(a.buffer=d,c){const b=audioContext.createGain();b.gain.value=c,b.connect(audioContext.destination),a.connect(b),a.start()}else a.connect(audioContext.destination),a.start()}async function loadAudio(a,c){if(audioBufferCache[a])return audioBufferCache[a];const d=await fetch(c),e=await d.arrayBuffer(),b=await audioContext.decodeAudioData(e);return audioBufferCache[a]=b,b}function unlockAudio(){audioContext.resume()}function getNumRange(a){switch(a){case 1:return[[9,1],[[10,5],[5,1]],[9,1],[[9,1],[5,1]]];case 2:return[[14,2],[[20,11],[10,1]],[9,1],[[19,1],[5,1]]];case 3:return[[19,4],[[26,16],[15,6]],[9,1],[[99,10],[9,1]]];case 4:return[[24,8],[[99,50],[50,11]],[9,1],[[99,20],[19,11]]];default:return[[49,11],[[99,50],[50,11]],[9,1],[[99,20],[19,11]]]}}let startTime,gameTimer;function startGameTimer(){correctCount=0,clearInterval(gameTimer);const a=document.getElementById("time");startTime=Date.now(),gameTimer=setInterval(()=>{a.textContent=(Date.now()-startTime)/1e3},200)}let countdownTimer;function countdown(){initTable(),clearTimeout(countdownTimer),countPanel.classList.remove("d-none"),infoPanel.classList.add("d-none"),scorePanel.classList.add("d-none");const a=document.getElementById("counter");a.textContent=3,countdownTimer=setInterval(()=>{const b=["skyblue","greenyellow","violet","tomato"];if(parseInt(a.textContent)>1){const c=parseInt(a.textContent)-1;a.style.backgroundColor=b[c],a.textContent=c}else clearTimeout(countdownTimer),countPanel.classList.add("d-none"),infoPanel.classList.remove("d-none"),startGameTimer()},1e3)}function initTableFontSize(){const a=document.getElementById("table"),b=a.offsetWidth;a.style.fontSize=b/11*.6+"px"}function initCalc(){document.getElementById("be").onclick=()=>{const a=document.getElementById("table").querySelector(".table-danger"),b=a.dataset.answer;speak(b)},document.getElementById("bc").onclick=()=>{const a=document.getElementById("table").querySelector(".table-danger");a.textContent=""};for(let a=0;a<10;a++)document.getElementById("b"+a).onclick=c=>{const b=document.getElementById("table").querySelector(".table-danger");let a=b.textContent;a+=c.target.getAttribute("id").slice(-1),a.length>2&&(a=a.slice(1,3)),b.textContent=a;const d=b.dataset.answer;if(d==a)if(playAudio("correct"),correctCount+=1,moveCursorNext(b),correctCount==100){playAudio("end"),clearInterval(gameTimer),infoPanel.classList.add("d-none"),scorePanel.classList.remove("d-none");const a=(Date.now()-startTime)/1e3;document.getElementById("score").textContent=a}}}function shuffle(a){for(let b=a.length;1<b;b--){const c=Math.floor(Math.random()*b);[a[c],a[b-1]]=[a[b-1],a[c]]}return a}function initTable(){initTableHeader(),initTableAnswers(),[...document.getElementById("table").querySelectorAll("td.table-danger")].forEach(a=>{a.className=""}),document.getElementById("table").getElementsByTagName("tr")[1].children[1].className="table-danger"}function initTableAnswers(){const a=document.getElementById("courseOption").selectedIndex,b=document.getElementById("table").getElementsByTagName("tr"),c=b[0].children;for(let e=1;e<b.length;e++){const d=b[e].children;for(let b=1;b<d.length;b++){let e;const f=parseInt(c[b].textContent),g=parseInt(d[0].textContent);a==0?e=f+g:a==1?e=f-g:a==2?e=f*g:e=Math.floor(f/g),d[b].dataset.answer=e,d[b].textContent=""}}}function initTableHeader(){const d=document.getElementById("table"),b=d.getElementsByTagName("th"),c=document.getElementById("gradeOption").selectedIndex+1,a=document.getElementById("courseOption").selectedIndex;if(a==1||a==3){let[g,e]=getNumRange(c)[a][0],f=Array.from(new Array(g-e+1)).map((b,a)=>a+e),d=shuffle(f.slice());d=d.concat(shuffle(f.slice()));for(let a=1;a<=10;a++)b[a].textContent=d[a];[g,e]=getNumRange(c)[a][1],f=Array.from(new Array(g-e+1)).map((b,a)=>a+e),d=shuffle(f.slice()),d=d.concat(shuffle(f.slice()));for(let a=11;a<=20;a++)b[a].textContent=d[a-11]}else{const[g,f]=getNumRange(c)[a],d=Array.from(new Array(g-f+1)).map((b,a)=>a+f);let e=shuffle(d);e=e.concat(shuffle(d.slice())).concat(shuffle(d.slice()));for(let a=1;a<=20;a++)b[a].textContent=e[a]}}function moveCursorNext(a){const f=a.parentNode,c=[...document.getElementById("table").getElementsByTagName("tr")],g=[...a.parentNode.children],d=g.indexOf(a),e=c.indexOf(f);let b;e==10?d==10?b=a:b=c[1].children[d+1]:b=c[e+1].children[d],a.className="",b.className="table-danger"}initTable(),initTableFontSize(),initCalc(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=countdown,document.getElementById("restartButton").onclick=countdown,document.getElementById("gradeOption").onchange=initTable,window.onresize=initTableFontSize,document.getElementById("courseOption").onchange=b=>{const a=b.target,c=a.options[a.selectedIndex].textContent;document.getElementById("courseText").innerHTML=c,initTable()},document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})