const infoPanel=document.getElementById("infoPanel"),scorePanel=document.getElementById("scorePanel");let endAudio,incorrectAudio,correctAudio;loadAudios();const AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext;loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&(document.documentElement.dataset.theme="dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),delete document.documentElement.dataset.theme):(localStorage.setItem("darkMode",1),document.documentElement.dataset.theme="dark")}function playAudio(c,b){const a=audioContext.createBufferSource();if(a.buffer=c,b){const c=audioContext.createGain();c.gain.value=b,c.connect(audioContext.destination),a.connect(c),a.start()}else a.connect(audioContext.destination),a.start()}function unlockAudio(){audioContext.resume()}function loadAudio(a){return fetch(a).then(a=>a.arrayBuffer()).then(a=>new Promise((b,c)=>{audioContext.decodeAudioData(a,a=>{b(a)},a=>{c(a)})}))}function loadAudios(){promises=[loadAudio("mp3/end.mp3"),loadAudio("mp3/incorrect1.mp3"),loadAudio("mp3/correct3.mp3")],Promise.all(promises).then(a=>{endAudio=a[0],incorrectAudio=a[1],correctAudio=a[2]})}function getNumRange(a){switch(a){case 1:return[[9,1],[[10,5],[5,1]],[9,1],[[9,1],[5,1]]];case 2:return[[14,2],[[20,11],[10,1]],[9,1],[[19,1],[5,1]]];case 3:return[[19,4],[[26,16],[15,6]],[9,1],[[99,10],[9,1]]];case 4:return[[24,8],[[99,50],[50,11]],[9,1],[[99,20],[19,11]]];default:return[[49,11],[[99,50],[50,11]],[9,1],[[99,20],[19,11]]]}}let startTime,gameTimer;function startGameTimer(){clearInterval(gameTimer);const a=document.getElementById("time");startTime=Date.now(),gameTimer=setInterval(function(){a.textContent=(Date.now()-startTime)/1e3},200)}let countdownTimer;function countdown(){initTable(),clearTimeout(countdownTimer),gameStart.classList.remove("d-none"),infoPanel.classList.add("d-none"),scorePanel.classList.add("d-none");const a=document.getElementById("counter");a.textContent=3,countdownTimer=setInterval(function(){const b=["skyblue","greenyellow","violet","tomato"];if(parseInt(a.textContent)>1){const c=parseInt(a.textContent)-1;a.style.backgroundColor=b[c],a.textContent=c}else clearTimeout(countdownTimer),gameStart.classList.add("d-none"),infoPanel.classList.remove("d-none"),document.getElementById("score").textContent=0,startGameTimer()},1e3)}function initTableFontSize(){const a=document.getElementById("table"),b=a.offsetWidth;a.style.fontSize=b/11*.6+"px"}function initCalc(){const a=document.getElementById("score");document.getElementById("be").onclick=function(){const b=document.getElementById("table").querySelector(".table-danger"),c=b.textContent,d=b.dataset.answer;if(d==c){playAudio(correctAudio),b.textContent="";const c=parseInt(a.textContent)+1;a.textContent=c,moveCursorNext(b),c==100&&(clearInterval(gameTimer),infoPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),a.textContent=(Date.now()-startTime)/1e3)}else playAudio(incorrectAudio)},document.getElementById("bc").onclick=function(){const a=document.getElementById("table").querySelector(".table-danger");a.textContent=""};for(let b=0;b<10;b++)document.getElementById("b"+b).onclick=function(){const c=document.getElementById("table").querySelector(".table-danger");let b=c.textContent;b+=this.getAttribute("id").slice(-1),b.length>2&&(b=b.slice(1,3)),c.textContent=b;const d=c.dataset.answer;if(d==b){playAudio(correctAudio);const b=parseInt(a.textContent)+1;a.textContent=b,moveCursorNext(c),b==100?(playAudio(endAudio),clearInterval(gameTimer),infoPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),a.textContent=(Date.now()-startTime)/1e3):b==1&&startGameTimer()}}}function shuffle(a){for(i=a.length;1<i;i--)k=Math.floor(Math.random()*i),[a[k],a[i-1]]=[a[i-1],a[k]];return a}function initTable(){initTableHeader(),initTableAnswers(),[...document.getElementById("table").querySelectorAll("td.table-danger")].forEach(a=>{a.className=""}),document.getElementById("table").getElementsByTagName("tr")[1].children[1].className="table-danger"}function initTableAnswers(){const a=document.getElementById("courseOption").selectedIndex,b=document.getElementById("table").getElementsByTagName("tr"),c=b[0].children;for(let e=1;e<b.length;e++){const d=b[e].children;for(let b=1;b<d.length;b++){let e;const f=parseInt(c[b].textContent),g=parseInt(d[0].textContent);a==0?e=f+g:a==1?e=f-g:a==2?e=f*g:e=Math.floor(f/g),d[b].dataset.answer=e,d[b].textContent=""}}}function initTableHeader(){const d=document.getElementById("table"),b=d.getElementsByTagName("th"),c=document.getElementById("gradeOption").selectedIndex+1,a=document.getElementById("courseOption").selectedIndex;if(a==1||a==3){let[g,e]=getNumRange(c)[a][0],f=Array.from(new Array(g-e+1)).map((b,a)=>a+e),d=shuffle(f.slice());d=d.concat(shuffle(f.slice()));for(let a=1;a<=10;a++)b[a].textContent=d[a];[g,e]=getNumRange(c)[a][1],f=Array.from(new Array(g-e+1)).map((b,a)=>a+e),d=shuffle(f.slice()),d=d.concat(shuffle(f.slice()));for(let a=11;a<=20;a++)b[a].textContent=d[a-11]}else{const[g,f]=getNumRange(c)[a],d=Array.from(new Array(g-f+1)).map((b,a)=>a+f);let e=shuffle(d);e=e.concat(shuffle(d.slice())).concat(shuffle(d.slice()));for(let a=1;a<=20;a++)b[a].textContent=e[a]}}function moveCursorNext(a){const f=a.parentNode,c=[...document.getElementById("table").getElementsByTagName("tr")],g=[...a.parentNode.children],d=g.indexOf(a),e=c.indexOf(f);let b;e==10?d==10?b=a:b=c[1].children[d+1]:b=c[e+1].children[d],a.className="",b.className="table-danger"}initTable(),initTableFontSize(),initCalc(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=countdown,document.getElementById("restartButton").onclick=countdown,document.getElementById("gradeOption").onchange=initTable,window.onresize=initTableFontSize,document.getElementById("courseOption").onchange=function(){const a=this.options[this.selectedIndex].textContent;document.getElementById("courseText").innerHTML=a,initTable()},document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})